<Window x:Class="factory_automation_system_FAS_.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:factory_automation_system_FAS_.ViewModels"
        xmlns:b="clr-namespace:factory_automation_system_FAS_.Behaviors"
        xmlns:m="clr-namespace:factory_automation_system_FAS_.Models"
        xmlns:views="clr-namespace:factory_automation_system_FAS_.Views"
        xmlns:me="clr-namespace:factory_automation_system_FAS_.ViewModels.MapEntities"
         Closing="MainWindow_OnClosing"
        Title="DT Control Center"
        Width="1920" Height="1080"
        WindowStartupLocation="CenterScreen"
        Background="#F5F7FA">

    <Window.Resources>
        <SolidColorBrush x:Key="Bg" Color="#F5F7FA"/>
        <SolidColorBrush x:Key="Panel" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="Card" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="BorderSoft" Color="#D7DEE8"/>

        <SolidColorBrush x:Key="Accent" Color="#2EE6A6"/>
        <SolidColorBrush x:Key="AccentSoft" Color="#22B892"/>
        <SolidColorBrush x:Key="Station" Color="#2563EB"/>
        <SolidColorBrush x:Key="Output" Color="#D97706"/>

        <Pen x:Key="GridPenMajor" Brush="#D7DEE8" Thickness="1"/>
        <Pen x:Key="GridPenMinor" Brush="#E6ECF4" Thickness="1"/>

        <DrawingBrush x:Key="GridBrush"
                      TileMode="Tile"
                      Viewport="0,0,160,160"
                      ViewportUnits="Absolute"
                      Stretch="None">
            <DrawingBrush.Drawing>
                <DrawingGroup>
                    <GeometryDrawing Brush="Transparent" Pen="{StaticResource GridPenMajor}">
                        <GeometryDrawing.Geometry>
                            <RectangleGeometry Rect="0,0,160,160"/>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                    <GeometryDrawing Brush="Transparent" Pen="{StaticResource GridPenMinor}">
                        <GeometryDrawing.Geometry>
                            <GeometryGroup>
                                <LineGeometry StartPoint="80,0" EndPoint="80,160"/>
                                <LineGeometry StartPoint="0,80" EndPoint="160,80"/>
                            </GeometryGroup>
                        </GeometryDrawing.Geometry>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingBrush.Drawing>
        </DrawingBrush>

        <Style x:Key="CardBox" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource Card}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="14"/>
            <Setter Property="Padding" Value="14"/>
        </Style>

        <!-- ✅ 탭 헤더만 숨기고 SelectedContent만 보여주는 TabControl 템플릿 -->
        <Style x:Key="NoHeaderTabControl" TargetType="{x:Type TabControl}">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type TabControl}">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}"
                                SnapsToDevicePixels="True">
                            <ContentPresenter Content="{TemplateBinding SelectedContent}"
                                              ContentTemplate="{TemplateBinding SelectedContentTemplate}"
                                              ContentStringFormat="{TemplateBinding SelectedContentStringFormat}"
                                              HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- =========================
             Step3: SelectedEntity Detail Templates
             ========================= -->

        <!-- 작은 뱃지 스타일 -->
        <Style x:Key="EntityBadgeBorderStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="10,4"/>
            <Setter Property="Background" Value="#E6ECF4"/>
        </Style>
        <Style x:Key="EntityBadgeTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="#0B1220"/>
        </Style>

        <!-- null일 때 안내 -->
        <DataTemplate x:Key="NoSelectionTemplate">
            <StackPanel>
                <TextBlock Text="Selected Entity"
                           Foreground="#0F172A"
                           FontWeight="SemiBold"
                           FontSize="15"
                           Margin="0,0,0,10"/>
                <TextBlock Text="선택된 엔티티가 없습니다. (지도 위 오브젝트를 클릭)"
                           Foreground="#94A3B8"
                           TextWrapping="Wrap"/>
            </StackPanel>
        </DataTemplate>

        <!-- 공통(기본) -->
        <DataTemplate DataType="{x:Type me:MapEntityVM}">
            <StackPanel>
                <TextBlock Text="{Binding DisplayName}"
                           Foreground="#0F172A"
                           FontWeight="SemiBold"
                           FontSize="15"
                           Margin="0,0,0,10"/>

                <WrapPanel Margin="0,0,0,12">
                    <Border Style="{StaticResource EntityBadgeBorderStyle}">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}"
                                   Text="{Binding Status}"/>
                    </Border>
                    <Border Style="{StaticResource EntityBadgeBorderStyle}" Margin="8,0,0,0">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}"
                                   Text="{Binding Id}"/>
                    </Border>
                </WrapPanel>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="X" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" Foreground="#0F172A"
                               Text="{Binding X, StringFormat={}{0:0}}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Y" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Foreground="#0F172A"
                               Text="{Binding Y, StringFormat={}{0:0}}"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Width/Height" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Foreground="#0F172A">
                        <Run Text="{Binding Width, StringFormat={}{0:0}}"/>
                        <Run Text=" × "/>
                        <Run Text="{Binding Height, StringFormat={}{0:0}}"/>
                    </TextBlock>

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="ZIndex" Foreground="#475569"/>
                    <TextBlock Grid.Row="3" Grid.Column="1" Foreground="#0F172A"
                               Text="{Binding ZIndex}"/>
                </Grid>
            </StackPanel>
        </DataTemplate>

        <!-- Conveyor -->
        <DataTemplate DataType="{x:Type me:ConveyorVM}">
            <StackPanel>
                <TextBlock Text="{Binding DisplayName}"
                           Foreground="#0F172A"
                           FontWeight="SemiBold"
                           FontSize="15"
                           Margin="0,0,0,10"/>

                <WrapPanel Margin="0,0,0,12">
                    <Border Style="{StaticResource EntityBadgeBorderStyle}">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}"
                                   Text="{Binding Status}"/>
                    </Border>
                    <Border Style="{StaticResource EntityBadgeBorderStyle}" Margin="8,0,0,0">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}" Text="Conveyor"/>
                    </Border>
                </WrapPanel>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Lane" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" Foreground="#0F172A" Text="{Binding Lane}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Direction" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Foreground="#0F172A" Text="{Binding Direction}"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Speed" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Foreground="#0F172A"
                               Text="{Binding Speed, StringFormat={}{0:0.##}}"/>

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="HasItem" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="3" Grid.Column="1" Foreground="#0F172A" Text="{Binding HasItem}"/>

                    <TextBlock Grid.Row="4" Grid.Column="0" Text="Blocked" Foreground="#475569"/>
                    <TextBlock Grid.Row="4" Grid.Column="1" Foreground="#0F172A" Text="{Binding IsBlocked}"/>
                </Grid>
            </StackPanel>
        </DataTemplate>

        <!-- Sensor -->
        <DataTemplate DataType="{x:Type me:SensorVM}">
            <StackPanel>
                <TextBlock Text="{Binding DisplayName}"
                           Foreground="#0F172A"
                           FontWeight="SemiBold"
                           FontSize="15"
                           Margin="0,0,0,10"/>

                <WrapPanel Margin="0,0,0,12">
                    <Border Style="{StaticResource EntityBadgeBorderStyle}">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}"
                                   Text="{Binding Status}"/>
                    </Border>
                    <Border Style="{StaticResource EntityBadgeBorderStyle}" Margin="8,0,0,0">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}" Text="Sensor"/>
                    </Border>
                </WrapPanel>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Type" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" Foreground="#0F172A" Text="{Binding SensorType}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Triggered" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Foreground="#0F172A" Text="{Binding IsTriggered}"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Value" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Foreground="#0F172A">
                        <Run Text="{Binding NumericValue, StringFormat={}{0:0.##}}"/>
                        <Run Text=" "/>
                        <Run Text="{Binding Unit}"/>
                    </TextBlock>

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Id" Foreground="#475569"/>
                    <TextBlock Grid.Row="3" Grid.Column="1" Foreground="#0F172A" Text="{Binding Id}"/>
                </Grid>
            </StackPanel>
        </DataTemplate>

        <!-- Camera -->
        <DataTemplate DataType="{x:Type me:CameraVM}">
            <StackPanel>
                <TextBlock Text="{Binding DisplayName}"
                           Foreground="#0F172A"
                           FontWeight="SemiBold"
                           FontSize="15"
                           Margin="0,0,0,10"/>

                <WrapPanel Margin="0,0,0,12">
                    <Border Style="{StaticResource EntityBadgeBorderStyle}">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}"
                                   Text="{Binding Status}"/>
                    </Border>
                    <Border Style="{StaticResource EntityBadgeBorderStyle}" Margin="8,0,0,0">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}" Text="Camera"/>
                    </Border>
                </WrapPanel>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Streaming" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" Foreground="#0F172A" Text="{Binding IsStreaming}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Url" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Foreground="#0F172A" Text="{Binding StreamUrl}" TextWrapping="Wrap"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Id" Foreground="#475569"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Foreground="#0F172A" Text="{Binding Id}"/>
                </Grid>
            </StackPanel>
        </DataTemplate>

        <!-- Barcode -->
        <DataTemplate DataType="{x:Type me:BarcodeScannerVM}">
            <StackPanel>
                <TextBlock Text="{Binding DisplayName}"
                           Foreground="#0F172A"
                           FontWeight="SemiBold"
                           FontSize="15"
                           Margin="0,0,0,10"/>

                <WrapPanel Margin="0,0,0,12">
                    <Border Style="{StaticResource EntityBadgeBorderStyle}">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}"
                                   Text="{Binding Status}"/>
                    </Border>
                    <Border Style="{StaticResource EntityBadgeBorderStyle}" Margin="8,0,0,0">
                        <TextBlock Style="{StaticResource EntityBadgeTextStyle}" Text="Barcode"/>
                    </Border>
                </WrapPanel>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="LastCode" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" Foreground="#0F172A" Text="{Binding LastCode}" TextWrapping="Wrap"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="ReadTime" Foreground="#475569" Margin="0,0,10,6"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Foreground="#0F172A"
                               Text="{Binding LastReadTime, StringFormat={}{0:HH:mm:ss}}"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Id" Foreground="#475569"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Foreground="#0F172A" Text="{Binding Id}"/>
                </Grid>
            </StackPanel>
        </DataTemplate>

    </Window.Resources>

    <Grid Margin="14">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="380"/>
        </Grid.ColumnDefinitions>

        <!-- =========================
             LEFT: 화면 전환 영역 (TabControl)
             MainTabIndex: 0=메인, 1=생산조회, 2=설정
             ========================= -->
        <TabControl Grid.Column="0"
                    Style="{StaticResource NoHeaderTabControl}"
                    SelectedIndex="{Binding MainTabIndex}"
                    BorderThickness="0"
                    Background="Transparent">

            <!-- ===== Tab 0: 메인 지도 ===== -->
            <TabItem>
                <views:MapView />
            </TabItem>

            <!-- ===== Tab 1: 생산조회(메인 내부 화면) ===== -->
            <TabItem>
                <Border Background="#FFFFFF"
                        BorderBrush="{StaticResource BorderSoft}"
                        BorderThickness="1"
                        CornerRadius="18"
                        Padding="16">
                    <views:ProductionQueryView DataContext="{Binding ProductionQueryVm}" />
                </Border>
            </TabItem>

            <!-- ===== Tab 2: 설정(유저 관리) ===== -->
            <TabItem>
                <Border Background="#FFFFFF"
                        BorderBrush="{StaticResource BorderSoft}"
                        BorderThickness="1"
                        CornerRadius="18"
                        Padding="16">
                    <views:SettingsView DataContext="{Binding SettingsVm}" />
                </Border>
            </TabItem>

        </TabControl>

        <!-- =========================
             RIGHT: 사이드바
             ========================= -->
        <Border Grid.Column="1"
                Margin="14,0,0,0"
                Background="{StaticResource Panel}"
                BorderBrush="{StaticResource BorderSoft}"
                BorderThickness="1"
                CornerRadius="18"
                Padding="18">

            <DockPanel LastChildFill="True">

                <Border DockPanel.Dock="Top"
                        Background="#0B1220"
                        CornerRadius="12"
                        Padding="16"
                        Margin="0,0,0,16">
                    <StackPanel>
                        <Image Source="/Assets/Brand/adp_logo_from_screenshot_transparent.png"
                               Height="110"
                               Stretch="Uniform"
                               Margin="0,0,0,12"/>
                    </StackPanel>
                </Border>

                <Border DockPanel.Dock="Bottom"
                        Background="{StaticResource Card}"
                        BorderBrush="{StaticResource BorderSoft}"
                        BorderThickness="1"
                        CornerRadius="14"
                        Padding="14">
                    <StackPanel>
                        <TextBlock Text="Factory Environment"
                                   Foreground="#0F172A"
                                   FontWeight="SemiBold"
                                   Margin="0,0,0,10"/>

                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Gas" Foreground="#475569" Margin="0,0,16,6"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="— ppm" Foreground="#475569"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Temperature" Foreground="#475569" Margin="0,0,16,6"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="— °C" Foreground="#475569"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Humidity" Foreground="#475569" Margin="0,0,16,6"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="— %" Foreground="#475569"/>

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="IP" Foreground="#475569" Margin="0,0,16,0"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="—" Foreground="#475569"/>
                        </Grid>

                        <TextBlock Text="No data connected (UI placeholder)"
                                   Foreground="#94A3B8"
                                   FontSize="11"
                                   Margin="0,10,0,0"/>
                    </StackPanel>
                </Border>

                <StackPanel>
                    <Button Content="생산조회"
                            Height="50"
                            Background="{StaticResource Accent}"
                            Foreground="#0B1220"
                            FontWeight="Bold"
                            BorderThickness="0"
                            Margin="0,0,0,16"
                            Width="330"
                            Command="{Binding OpenProductionQueryCommand}"/>

                    <Button Content="홈(메인)으로"
                            Height="44"
                            Background="#E6ECF4"
                            Foreground="#0B1220"
                            FontWeight="SemiBold"
                            BorderThickness="0"
                            Margin="0,0,0,16"
                            Width="330"
                            Command="{Binding NavigateHomeCommand}"/>

                    <Button Content="설정(유저관리)"
                            Height="44"
                            Background="#E6ECF4"
                            Foreground="#0B1220"
                            FontWeight="SemiBold"
                            BorderThickness="0"
                            Margin="0,0,0,16"
                            Width="330"
                            Command="{Binding NavigateSettingsCommand}"/>
                    


                    <Button Content="제품 +1 (Output)"
                            Height="50"
                            Margin="0,0,0,16"
                            Background="#E11919"
                            Foreground="#0B1220"
                            FontWeight="Bold"
                            BorderThickness="0"
                            Command="{Binding AddStockCommand}"
                            CommandParameter="{x:Static m:StationId.Output}"/>

                    <Border Height="1" Background="#D7DEE8" Margin="0,6,0,12"/>
                </StackPanel>

                <!-- ✅ Step3: SelectedEntity 상세 패널 (여기가 핵심) -->
                <Border Background="{StaticResource Card}"
                        BorderBrush="{StaticResource BorderSoft}"
                        BorderThickness="1"
                        CornerRadius="14"
                        Padding="14">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <ContentControl Content="{Binding SelectedEntity}">
                            <ContentControl.Style>
                                <Style TargetType="ContentControl">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedEntity}" Value="{x:Null}">
                                            <Setter Property="ContentTemplate" Value="{StaticResource NoSelectionTemplate}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ContentControl.Style>
                        </ContentControl>
                    </ScrollViewer>
                </Border>

            </DockPanel>
        </Border>

    </Grid>
</Window>
