<UserControl x:Class="factory_automation_system_FAS_.Views.MapView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:b="clr-namespace:factory_automation_system_FAS_.Behaviors"
             
             Background="Transparent"
             Focusable="True">

    <!-- ✅ 키보드 nudge -->
    <UserControl.InputBindings>
        <!-- 1px 이동 -->
        <KeyBinding Key="Left"  Command="{Binding NudgeSelectedEntityCommand}" CommandParameter="Left"/>
        <KeyBinding Key="Right" Command="{Binding NudgeSelectedEntityCommand}" CommandParameter="Right"/>
        <KeyBinding Key="Up"    Command="{Binding NudgeSelectedEntityCommand}" CommandParameter="Up"/>
        <KeyBinding Key="Down"  Command="{Binding NudgeSelectedEntityCommand}" CommandParameter="Down"/>

        <!-- 10px 이동 (Shift) -->
        <KeyBinding Key="Left"  Modifiers="Shift" Command="{Binding NudgeSelectedEntityCommand}" CommandParameter="ShiftLeft"/>
        <KeyBinding Key="Right" Modifiers="Shift" Command="{Binding NudgeSelectedEntityCommand}" CommandParameter="ShiftRight"/>
        <KeyBinding Key="Up"    Modifiers="Shift" Command="{Binding NudgeSelectedEntityCommand}" CommandParameter="ShiftUp"/>
        <KeyBinding Key="Down"  Modifiers="Shift" Command="{Binding NudgeSelectedEntityCommand}" CommandParameter="ShiftDown"/>
    </UserControl.InputBindings>

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>

                <!-- ✅ 엔티티 템플릿(Conveyor/Sensor/Camera/Barcode/Device) -->
                <!-- (권장) pack uri로 강제 -->
                <ResourceDictionary Source="pack://application:,,,/factory_automation_system_FAS_;component/Themes/MapEntities.Templates.xaml"/>

                <!-- (대안) 아래 한 줄로도 되는 경우 많음 -->
                <!-- <ResourceDictionary Source="/Themes/MapEntities.Templates.xaml"/> -->

            </ResourceDictionary.MergedDictionaries>

            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
            

            <!-- ✅ map bg -->
            <BitmapImage x:Key="MainLayoutBmp"
                         UriSource="pack://application:,,,/factory_automation_system_FAS_;component/Assets/Maps/main_layout.png"
                         CacheOption="OnLoad" />

            <CroppedBitmap x:Key="MapBg"
                           Source="{StaticResource MainLayoutBmp}"
                           SourceRect="0,150,3100,1700" />
        </ResourceDictionary>
    </UserControl.Resources>

    <Border Background="{DynamicResource Card}"
            BorderBrush="{DynamicResource BorderSoft}"
            BorderThickness="1"
            CornerRadius="16"
            Padding="10">

        <Viewbox Stretch="Uniform" StretchDirection="DownOnly">
            <Canvas x:Name="MapCanvas"
                    Width="3100" Height="1700"
                    b:MapInputBehavior.TargetCanvas="{Binding ElementName=MapCanvas}"
                    b:MapInputBehavior.PanCommand="{Binding PanCommand}"
                    b:MapInputBehavior.ZoomCommand="{Binding ZoomCommand}"
                    Background="Transparent">

                <Canvas.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform ScaleX="{Binding Viewport.Scale}"
                                        ScaleY="{Binding Viewport.Scale}" />
                        <TranslateTransform X="{Binding Viewport.TranslateX}"
                                            Y="{Binding Viewport.TranslateY}" />
                    </TransformGroup>
                </Canvas.RenderTransform>

                <!-- Background -->
                <Image Canvas.Left="0" Canvas.Top="0"
                       Width="3100" Height="1700"
                       Source="{StaticResource MapBg}"
                       Stretch="Fill" />

                <!-- DEBUG -->
                <Border Canvas.Left="20" Canvas.Top="20"
                        Background="#CC000000"
                        CornerRadius="8"
                        Padding="10"
                        Panel.ZIndex="9999">
                    <StackPanel>
                        <TextBlock Foreground="White" FontSize="18" FontWeight="Bold"
                                   Text="{Binding MapEntityCount, StringFormat=Entities: {0}}"/>
                        <TextBlock Foreground="White" FontSize="14"
                                   Text="{Binding SelectedEntity.Id, StringFormat=Selected: {0}}"/>
                    </StackPanel>
                </Border>

                <!-- Entities -->
                <ItemsControl ItemsSource="{Binding MapEntities}"
                              Canvas.Left="0" Canvas.Top="0"
                              Width="3100" Height="1700"
                              Panel.ZIndex="50">

                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.RenderTransform>
                        <TranslateTransform Y="-150"/>
                    </ItemsControl.RenderTransform>


                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                            <Setter Property="Panel.ZIndex" Value="{Binding ZIndex}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>

                    <!-- ✅ 템플릿은 Themes/MapEntities.Templates.xaml 안에 있음 -->
                </ItemsControl>

                <!-- RC카 -->
                <Border Width="70" Height="70"
                        CornerRadius="16"
                        Background="#2EE6A6"
                        BorderBrush="#0F2E25"
                        BorderThickness="2"
                        Canvas.Left="{Binding CartX}"
                        Canvas.Top="{Binding CartY}"
                        Panel.ZIndex="100">
                    <TextBlock Text="RC"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               FontWeight="Bold"
                               Foreground="#0B0F14"/>
                </Border>

                <!-- 카트 적재 제품 -->
                <Ellipse Width="18" Height="18"
                         Fill="#FF4D4D"
                         Stroke="#7A1E1E"
                         StrokeThickness="2"
                         Canvas.Left="{Binding CartLoadX}"
                         Canvas.Top="{Binding CartLoadY}"
                         Visibility="{Binding CartHasLoad, Converter={StaticResource BoolToVis}}"
                         Panel.ZIndex="120"/>
            </Canvas>
        </Viewbox>
    </Border>
</UserControl>
